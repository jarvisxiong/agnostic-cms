sudo a2enmod auth_form
sudo a2enmod session
sudo a2enmod session_cookie
sudo a2enmod authn_dbd
sudo a2enmod session_crypto
sudo a2enmod proxy
sudo a2enmod proxy_http
sudo a2enmod session_dbd
sudo a2enmod headers
sudo a2enmod ssl
sudo a2enmod rewrite
sudo service apache2 restart

php -r "echo '{SHA}' . base64_encode(sha1('admin', true)) . \"\n\";"

sudo apt-get install libaprutil1-dbd-pgsql

openssl genrsa -out cmstest.key 2048
openssl req -new -key cmstest.key -out cmstestrequest.csr
openssl x509 -req -days 365 -in cmstestrequest.csr -signkey cmstest.key -out cmstest.crt
rm cmstestrequest.csr

sudo mkdir /etc/apache2/keys
sudo mv ./cmstest.crt /etc/apache2/keys
sudo mv ./cmstest.key /etc/apache2/keys





ServerName localhost


<VirtualHost *:443>

	DocumentRoot /var/www/

	DBDriver pgsql
	DBDParams "host=localhost dbname=agnosticcms port=5433 user=postgres password=postgres"
	DBDMin  4
	DBDKeep 8
	DBDMax  20
	DBDExptime 300
	DBDPrepareSQL "delete from cms_sessions where key = %s" deletesession
	DBDPrepareSQL "update cms_sessions set value = %s, expiry = %lld, key = %s where key = %s" updatesession
	DBDPrepareSQL "insert into cms_sessions (value, expiry, key) values (%s, %lld, %s)" insertsession
	DBDPrepareSQL "select value from cms_sessions where key = %s and (expiry = 0 or expiry > %lld)" selectsession
	DBDPrepareSQL "delete from cms_sessions where expiry != 0 and expiry < %lld" cleansession

	SSLEngine on
	SSLCertificateFile keys/cmstest.crt
	SSLCertificateKeyFile keys/cmstest.key

	<Location /cms>
	  AuthFormProvider dbd
	  AuthType form
	  AuthName cms
	 
	  Session On
	  SessionEnv On
	  SessionDBDCookieName session path=/
	  SessionCryptoPassphrase asjindsdci1232TFA74jas71QWsa
	  SessionHeader X-Replace-Session
	  RequestHeader set X-Session "%{HTTP_SESSION}e"
	  
	  ErrorDocument 401 /login.html
	  AuthFormLoginSuccessLocation /cms/home

	  Require valid-user
	  
	  AuthDBDUserPWQuery "SELECT password as password FROM cms_users WHERE username = %s"

	</Location>

	ProxyPass /cms/php http://localhost:8081
	ProxyPassReverse  /cms/php http://localhost:8081
	ProxyPassReverseCookieDomain  localhost:8081 localhost
	ProxyPassReverseCookiePath  /  /cms

	ProxyPass /cms http://localhost:8080/cms
	ProxyPassReverse  /cms http://localhost:8080/cms
	ProxyPassReverseCookieDomain  localhost:8080 localhost
	
</VirtualHost>





<Directory "/home/tom/Desktop/Agnostic CMS/agnostic-cms/agnostic-test-backend-php">
	Options Indexes FollowSymLinks
	AllowOverride All
	Require all granted
</Directory>


Listen 8081
<VirtualHost *:8081>
	DocumentRoot "/home/tom/Desktop/Agnostic CMS/agnostic-cms/agnostic-test-backend-php"
</VirtualHost>
